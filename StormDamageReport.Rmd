---
title: "Storm Damage Report"
author: "Hal Peterson"
date: "January 24, 2015"
output: html_document
---

# Synopsis



# Data Processing

## Load data set

```{r cache=TRUE}
storms <- read.csv ('StormData.csv.bz2')
```

Convert damage exponents to numeric values.
For the first step we ignore R warnings, because we expect them: not every EXP level is a string representing a number.

```{r warning=FALSE}
allExponents <- union (levels (storms$CROPDMGEXP),
                       levels (storms$PROPDMGEXP))
numex <- as.numeric (allExponents)
```
```{r}
numex[allExponents %in% c('h', 'H')] <- 2
numex[allExponents %in% c('k', 'K')] <- 3
numex[allExponents %in% c('m', 'M')] <- 6
numex[allExponents %in% c('b', 'B')] <- 9
numex[allExponents %in% c('', '?', '-', '+')] <- 0
numex <- 10 ^ numex
```

Do not trust the enumeration conversion: complain bitterly if it missed any *EXP codes.
Otherwise, display the values (because it doesn't hurt).

```{r}
if (any (is.na (numex))) {
  print (allExponents[is.na (numex)])
  stop ('INPUT ERROR: unknown values of CROPDMGEXP and/or PROPDMGEXP')
} else {
  unique (numex)
}
```

Categories gleaned from NOAA, plus some tools for cleaning the raw data:

```{r}
stormTypes <- c ('Astronomical Low Tide',
                 'Avalanche',
                 'Blizzard',
                 'Coastal Flood',
                 'Cold/Wind Chill',
                 'Debris Flow',
                 'Dense Fog',
                 'Dense Smoke',
                 'Drought',
                 'Dust Devil',
                 'Dust Storm',
                 'Excessive Heat',
                 'Extreme Cold/Wind Chill',
                 'Flash Flood',
                 'Flood',
                 'Freezing Fog',
                 'Frost/Freeze',
                 'Funnel Cloud',
                 'Hail',
                 'Heat',
                 'Heavy Rain',
                 'Heavy Snow',
                 'High Surf',
                 'High Wind',
                 'Hurricane/Typhoon',
                 'Ice Storm',
                 'Lakeshore Flood',
                 'Lake-Effect Snow',
                 'Lightning',
                 'Marine Hail',
                 'Marine High Wind',
                 'Marine Strong Wind',
                 'Marine Thunderstorm Wind',
                 'Rip Current',
                 'Seiche',
                 'Sleet',
                 'Storm Tide',
                 'Strong Wind',
                 'Thunderstorm Wind',
                 'Tornado',
                 'Tropical Depression',
                 'Tropical Storm',
                 'Tsunami',
                 'Volcanic Ash',
                 'Waterspout',
                 'Wildfire',
                 'Winter Storm',
                 'Winter Weather' )

```

Associate each official event type with a regular expression to match against actual EVTYPE values. These expressions were painstakingly based on the data, but changes to the data must make them obsolete, sooner or later.

```{r}
stormMatch = c ('astro.*low',
                'aval',
                'bliz',
                'coast',
                'cold|chill',
                'flow|landslide',
                'dense fog',
                'dense smoke',
                'drought',
                'dev|landspout',
                'dust.*storm',
                '(exce|record).*heat',
                'extreme cold|chill',
                'flash',
                'flood',
                '(freez|ice).* fog',
                'frost|freeze',
                'funnel',
                'hail',
                'heat',
                'rain',
                'snow',
                'surf',
                'wind',
                'typh|hurr',
                'ice storm',
                'lakeshore',
                'lake.*effect',
                'light[a-z]*ing',
                'marine hail',
                'marine high wind',
                'marine strong wind',
                'marine t.* wind',
                'rip',
                'seiche',
                'sleet',
                'storm.*tide',
                'strong',
                '(thun|tstm).*wind',
                'torn',
                'depre',
                'trop.*storm',
                'tsu',
                'volc',
                'spout',
                'wild',
                'winter.*storm',
                'winter.*weather')
```


From the data pull the actual (messy!) values of EVTYPE, and match them with official event types.

```{r}
toOfficial <- factor (NA, levels=stormTypes)
for (evt in levels (storms$EVTYPE)) {
  for (i in 1 : length (stormTypes)) {
    if (regexpr (stormMatch[i], evt, ignore.case=TRUE) >= 0) {
      toOfficial[evt] <- stormTypes[i]
      break
    }
  }
}

sum (is.na (toOfficial))
length (toOfficial)
head (toOfficial)
```


# Results
